name: Publish Release

on:
  release:
    types: [published, created]

jobs:
  # Job 1: Build all packages
  build-packages:
    name: Build Package ${{ matrix.package }}
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        package: ["common", "media", "core", "platforms", "cli"]
    steps:
      - name: Checkout release tag
        uses: actions/checkout@v6
        with:
          ref: ${{ github.event.release.tag_name }}

      - name: Set up Python 3.12
        uses: actions/setup-python@v6
        with:
          python-version: "3.12"

      - name: Install build tools
        run: |
          python3 -m pip install build twine

      - name: Build package
        run: |
          cd packages/${{ matrix.package }}
          python3 -m build

      - name: Check package
        run: |
          cd packages/${{ matrix.package }}
          twine check dist/*

      - name: Upload build artifacts
        uses: actions/upload-artifact@v6
        with:
          name: dist-${{ matrix.package }}
          path: packages/${{ matrix.package }}/dist/*
          retention-days: 90

  # Job 2: Publish to PyPI
  publish-to-pypi:
    name: Publish to PyPI
    runs-on: ubuntu-22.04
    needs: build-packages
    permissions:
      id-token: write # Required for trusted publishing
      contents: write # Required to upload assets to release
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v7
        with:
          path: dist/

      - name: Display structure of downloaded files
        run: ls -R dist/

      # Publish packages in dependency order
      - name: Publish agoras-common
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist/dist-common/

      - name: Wait for agoras-common to be available on PyPI
        run: |
          echo "Waiting 30 seconds for package to be indexed on PyPI..."
          sleep 30

      - name: Publish agoras-media
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist/dist-media/

      - name: Wait for agoras-media to be available on PyPI
        run: |
          echo "Waiting 30 seconds for package to be indexed on PyPI..."
          sleep 30

      - name: Publish agoras-core
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist/dist-core/

      - name: Wait for agoras-core to be available on PyPI
        run: |
          echo "Waiting 30 seconds for package to be indexed on PyPI..."
          sleep 30

      - name: Publish agoras-platforms
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist/dist-platforms/

      - name: Wait for agoras-platforms to be available on PyPI
        run: |
          echo "Waiting 30 seconds for package to be indexed on PyPI..."
          sleep 30

      - name: Publish agoras (CLI)
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist/dist-cli/

      # Upload all distribution files to the GitHub release as assets
      - name: Upload release assets
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/dist-common/*
            dist/dist-media/*
            dist/dist-core/*
            dist/dist-platforms/*
            dist/dist-cli/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Job 3: Verify installation
  verify-installation:
    name: Verify PyPI Installation
    runs-on: ubuntu-22.04
    needs: publish-to-pypi
    strategy:
      matrix:
        python-version: ["3.10", "3.11", "3.12", "3.13", "3.14"]
    steps:
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}

      - name: Wait for PyPI to index all packages
        run: |
          echo "Waiting 60 seconds for all packages to be fully indexed on PyPI..."
          sleep 60

      - name: Install agoras from PyPI
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install agoras==${{ github.event.release.tag_name }}

      - name: Verify installation
        run: |
          agoras --version
          agoras --help

      - name: Test import
        run: |
          python3 -c "import agoras.common; import agoras.media; import agoras.core; import agoras.platforms; import agoras.cli"

  # Job 4: Trigger ReadTheDocs webhook
  trigger-readthedocs:
    name: Trigger ReadTheDocs Build
    runs-on: ubuntu-22.04
    needs: publish-to-pypi
    steps:
      - name: Trigger ReadTheDocs webhook
        env:
          RTD_WEBHOOK_URL: ${{ secrets.RTD_WEBHOOK_URL }}
          RTD_WEBHOOK_TOKEN: ${{ secrets.RTD_WEBHOOK_TOKEN }}
        run: |
          if [ -n "$RTD_WEBHOOK_URL" ] && [ -n "$RTD_WEBHOOK_TOKEN" ]; then
            curl -X POST \
              -d "branches=${{ github.event.release.tag_name }}" \
              -d "token=$RTD_WEBHOOK_TOKEN" \
              "$RTD_WEBHOOK_URL"
            echo "Triggered ReadTheDocs build for version ${{ github.event.release.tag_name }}"
          else
            echo "ReadTheDocs webhook secrets not configured, skipping webhook trigger"
          fi
