---
description:
globs:
alwaysApply: false
---
# Adding a New Social Network Platform (OAuth 2.0 Authentication)

## Overview

To add a new social network platform with **OAuth 2.0 authentication** (e.g., "newplatform" using OAuth flow like TikTok, Threads, Pinterest, Bluesky, or Mastodon), follow this systematic approach based on the existing OAuth architecture patterns.

> **Note**: This guide is for platforms using OAuth 2.0 authentication. For simple authentication (API keys, bot tokens), see the separate simple authentication guide.

## Required Files to Create

### 1. Core Module

Create `[agoras/core/newplatform.py](mdc:agoras/core/newplatform.py)` following the pattern of existing OAuth platforms like [agoras/core/tiktok.py](mdc:agoras/core/tiktok.py):

- Main platform integration logic
- High-level posting and interaction methods
- Platform-specific configuration handling

### 2. API Module

Create `[agoras/core/api/newplatform.py](mdc:agoras/core/api/newplatform.py)` following the pattern of [agoras/core/api/tiktok.py](mdc:agoras/core/api/tiktok.py):

- Low-level API interaction methods
- Platform-specific API endpoints and data formatting
- Error handling and response processing

### 3. OAuth Authentication Module

Create `[agoras/core/api/auth/newplatform.py](mdc:agoras/core/api/auth/newplatform.py)` following the pattern of [agoras/core/api/auth/tiktok.py](mdc:agoras/core/api/auth/tiktok.py):

- **OAuth 2.0 flow implementation** with authlib or platform-specific libraries
- **Authorization URL generation** with proper scopes
- **Code exchange for tokens** (authorization code flow)
- **Token refresh logic** for long-term usage
- **PKCE support** (if required by platform)
- **Platform-specific compliance fixes** (like TikTok's client_key vs client_id)

### 4. OAuth Client Module

Create `[agoras/core/api/clients/newplatform.py](mdc:agoras/core/api/clients/newplatform.py)` following the pattern of [agoras/core/api/clients/tiktok.py](mdc:agoras/core/api/clients/tiktok.py):

- HTTP client configuration with OAuth headers
- Bearer token authentication
- Request/response handling with OAuth error codes
- Rate limiting and retry logic

## OAuth-Specific Implementation Details

### Authentication Manager Requirements

Your auth manager must implement:

```python
class NewPlatformAuthManager(BaseAuthManager):
    def __init__(self, username: str, client_id: str, client_secret: str,
                 refresh_token: Optional[str] = None):
        # OAuth session setup with authlib or platform library
        # Examples:
        # - TikTok: OAuth2Session with compliance fixes
        # - Threads: ThreadsPipe for Meta OAuth
        # - Pinterest: Standard OAuth2Session
        # - Bluesky: atproto Client with password or OAuth options
        # - Mastodon: Mastodon.py with instance-specific OAuth

    async def authorize(self) -> Optional[str]:
        # Browser-based OAuth flow
        # Generate authorization URL
        # Handle callback and exchange code for tokens
        # Return refresh token

    async def _refresh_access_token(self) -> dict:
        # Use OAuth session to refresh tokens
        # Handle platform-specific token format
```

### Key OAuth Components to Implement

1. **Authorization URL Generation**:
   - Include proper scopes for platform permissions
   - Generate state parameter for security
   - Handle PKCE if required

2. **Browser Authorization Flow**:
   - Open browser to authorization URL
   - Handle callback URL capture
   - Parse authorization code from callback

3. **Token Exchange**:
   - Exchange authorization code for access/refresh tokens
   - Handle platform-specific token format quirks
   - Store refresh token securely

4. **Token Refresh**:
   - Implement automatic token refresh before expiration
   - Handle refresh token rotation
   - Update cached credentials

5. **Compliance Fixes** (if needed):
   - Handle non-standard OAuth implementations
   - Custom parameter names (like TikTok's client_key)
   - Custom token request formats

## Platform-Specific Implementation Patterns

### Standard OAuth 2.0 (LinkedIn, Pinterest)

```python
class StandardAuthManager(BaseAuthManager):
    def __init__(self, client_id: str, client_secret: str, redirect_uri: str):
        self.oauth_session = OAuth2Session(
            client_id=client_id,
            client_secret=client_secret,
            redirect_uri=redirect_uri,
            scope="required.scopes"
        )
```

### Library-Based OAuth (Threads, Bluesky)

```python
class LibraryAuthManager(BaseAuthManager):
    def __init__(self, app_id: str, app_secret: str):
        # Use platform-specific library for OAuth
        # Example: ThreadsPipe, atproto Client
        self.platform_client = PlatformLibrary(
            app_id=app_id,
            app_secret=app_secret
        )
```

### Multi-Instance OAuth (Mastodon)

```python
class InstanceAuthManager(BaseAuthManager):
    def __init__(self, instance_url: str, client_id: str = None):
        self.instance_url = instance_url
        # Support automatic app registration per instance
        if not client_id:
            self._register_app_with_instance()
```

### Dual Authentication (Bluesky)

```python
class DualAuthManager(BaseAuthManager):
    def __init__(self, identifier: str, password: str = None,
                 oauth_client_id: str = None):
        # Support both password and OAuth authentication
        if password:
            self._setup_password_auth()
        elif oauth_client_id:
            self._setup_oauth_auth()
```

## Files to Update

### 1. API Package Initialization

Update [agoras/core/api/**init**.py](mdc:agoras/core/api/__init__.py):

- Add imports for the new OAuth platform modules
- Export the new API class in `__all__`

### 2. Core Base Module

Update [agoras/core/base.py](mdc:agoras/core/base.py):

- Add platform-specific base classes if needed
- Update any platform enumeration or configuration

### 3. Package Initialization

Update relevant `__init__.py` files:

- [agoras/core/api/auth/**init**.py](mdc:agoras/core/api/auth/__init__.py)
- [agoras/core/api/clients/**init**.py](mdc:agoras/core/api/clients/__init__.py)

## OAuth-Specific Documentation Requirements

### 1. OAuth Credentials Documentation

Create `docs/credentials/newplatform.rst` following the pattern of [docs/credentials/tiktok.rst](mdc:docs/credentials/tiktok.rst):

- **OAuth app registration process** with screenshots
- **Required OAuth scopes and permissions**
- **Redirect URI configuration** (typically `http://localhost:3456/callback`)
- **Client ID and Client Secret generation**
- **Initial authorization flow walkthrough**
- **Platform-specific requirements** (business accounts, verification, etc.)

### 2. Platform Usage Documentation

Create `docs/newplatform.rst` following the pattern of [docs/tiktok.rst](mdc:docs/tiktok.rst):

- **OAuth setup and first-time authorization**
- **Token refresh and maintenance**
- **Platform-specific usage examples**
- **Troubleshooting OAuth-specific issues**

## OAuth Implementation Checklist

1. **Study OAuth Implementation**: Review [agoras/core/api/auth/tiktok.py](mdc:agoras/core/api/auth/tiktok.py) and related files
2. **Research Platform Library**: Identify if platform has official Python library
3. **Set Up OAuth Dependencies**: Ensure required libraries are available
4. **Implement OAuth Flow**: Create authorization URL generation and token exchange
5. **Handle Compliance Issues**: Add platform-specific fixes if needed
6. **Test Authorization Flow**: Verify browser authorization works end-to-end
7. **Test Token Refresh**: Ensure tokens refresh automatically
8. **Create OAuth Documentation**: Document the full OAuth setup process
9. **Add Error Handling**: Handle OAuth-specific errors (invalid_grant, expired_token, etc.)

## Platform-Specific Considerations

### Business Account Requirements (Threads, Instagram)

- Document business verification process
- Handle business account-specific limitations
- App review requirements for production

### Rate Limiting (Pinterest, all platforms)

- Implement proper retry logic with exponential backoff
- Document platform-specific rate limits
- Handle rate limit errors gracefully

### Multi-Instance Support (Mastodon)

- Support configuration of multiple instances
- Automatic app registration per instance
- Instance-specific credential caching

### Decentralized Architecture (Bluesky)

- Support custom server endpoints
- Handle DID-based identity systems
- AT Protocol specific requirements

### Character Limits and Features

- Detect platform-specific character limits
- Handle varying feature availability
- Instance or account-specific capabilities

## New CLI Actions

Some platforms may introduce new actions:

- `reply` - Reply to posts (Threads, Bluesky, Mastodon)
- `quote` - Quote posts (Bluesky)
- `create-board` - Create boards (Pinterest)
- `analytics` - Get analytics data (Pinterest, Threads)

## OAuth-Specific Architecture Patterns

- **Secure Token Storage**: Refresh tokens must be stored securely and never logged
- **Browser Integration**: Authorization requires opening browser and handling callbacks
- **Token Lifecycle Management**: Implement automatic refresh before expiration
- **State Validation**: Use state parameter to prevent CSRF attacks
- **PKCE Support**: Implement PKCE for enhanced security if supported
- **Compliance Handling**: Be prepared for platform-specific OAuth quirks
- **Error Recovery**: Handle authorization failures gracefully with re-authorization

## Common OAuth Integration Points

- **Authorization Server**: Platform's OAuth authorization endpoint
- **Token Endpoint**: Platform's token exchange and refresh endpoint
- **Callback Handler**: Local server or manual URL paste for receiving authorization code
- **Scope Configuration**: Platform-specific permissions required
- **Token Storage**: Secure caching of refresh tokens for reuse

## OAuth Error Handling

Implement handling for common OAuth errors:

- `invalid_grant`: Refresh token expired, need re-authorization
- `invalid_client`: Client credentials incorrect
- `insufficient_scope`: Need additional permissions
- `access_denied`: User denied authorization
- `temporarily_unavailable`: Platform OAuth service issues

## Platform Examples

### TikTok (Existing)

- OAuth 2.0 with PKCE and compliance fixes
- Business creator account requirements
- Complex authorization flow with authlib

### Threads (Existing)

- Meta OAuth 2.0 with ThreadsPipe library
- Business account verification required
- Long-lived tokens with 60-day expiration

### LinkedIn (Existing)

- Standard OAuth 2.0 implementation
- OpenID Connect support (scopes: openid, profile, email)
- Token refresh and caching

### Pinterest (Planned)

- Standard OAuth 2.0 implementation
- Board-based content organization
- Rate limiting considerations

### Bluesky (Planned)

- AT Protocol with dual authentication options
- Decentralized architecture support
- Custom server endpoints

### Mastodon (Planned)

- Multi-instance OAuth 2.0 support
- Automatic app registration
- Instance-specific features and limits
